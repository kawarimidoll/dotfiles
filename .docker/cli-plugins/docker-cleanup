#!/bin/bash
# docker-cleanup - Docker CLI Plugin

set -e

# Docker CLIãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å¿œç­”
if [ "$1" = "docker-cli-plugin-metadata" ]; then
  cat <<METADATA
{
  "SchemaVersion": "0.1.0",
  "Vendor": "kawarimidoll",
  "Version": "1.0.0",
  "ShortDescription": "Cleanup Docker resources",
  "URL": "https://github.com/kawarimidoll/dotfiles"
}
METADATA
  exit 0
fi

# echo "0 $0" /Users/kawarimidoll/.docker/cli-plugins/docker-cleanup
# echo "1 $1" cleanup
# echo "2 $2" ã‚ªãƒ—ã‚·ãƒ§ãƒ³

# ä½¿ç”¨æ–¹æ³•ã‚’è¡¨ç¤º
show_usage() {
  cat <<USAGE
Usage: docker cleanup [OPTIONS]

Docker ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ„ãƒ¼ãƒ«

Options:
  --project    ç¾åœ¨ã®Docker Composeãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                (ã‚³ãƒ³ãƒ†ãƒŠã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å‰Šé™¤)
                docker compose down -v --remove-orphans

  --unused     æœªä½¿ç”¨ã®Dockerãƒªã‚½ãƒ¼ã‚¹ã®ã¿ã‚’å‰Šé™¤
                (åœæ­¢ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã€æœªä½¿ç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯)
                docker system prune -a --volumes -f

  --all        ã™ã¹ã¦ã®Dockerãƒªã‚½ãƒ¼ã‚¹ã‚’å¼·åˆ¶å‰Šé™¤
                (å®Ÿè¡Œä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã‚‚åœæ­¢ãƒ»å‰Šé™¤ã€ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚ã‚Š)
                docker system prune -a --volumes -f
                docker volume ls -q | xargs docker volume rm 2>/dev/null || true

  --help       ã“ã®ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

Examples:
  docker cleanup --project    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚»ãƒƒãƒˆï¼ˆæ—¥å¸¸çš„ã«ä½¿ç”¨ï¼‰
  docker cleanup --unused     # æœªä½¿ç”¨ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤ï¼ˆé€±æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ï¼‰
  docker cleanup --all        # å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆç·Šæ€¥æ™‚ã®ã¿ï¼‰
USAGE
}

# ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
case "${2:-}" in
  --project)
    echo "ğŸ§¹ ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
    docker compose down -v --remove-orphans
    echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
    ;;

  --unused)
    echo "ğŸ§¹ æœªä½¿ç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
    docker system prune -a --volumes -f
    echo "âœ… æœªä½¿ç”¨ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
    ;;

  --all)
    echo "âš ï¸  è­¦å‘Š: ã™ã¹ã¦ã®Dockerãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™"
    echo "å®Ÿè¡Œä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã‚‚åœæ­¢ãƒ»å‰Šé™¤ã•ã‚Œã¾ã™ã€‚"
    echo "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
      echo "ğŸ›‘ ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ä¸­..."
      docker ps -q | xargs -r docker stop 2>/dev/null || true

      echo "ğŸ§¹ ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­..."
      docker system prune -a --volumes -f

      # æ®‹ã£ã¦ã„ã‚‹ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚å‰Šé™¤
      if [ "$(docker volume ls -q)" ]; then
        docker volume ls -q | xargs docker volume rm 2>/dev/null || true
      fi

      echo "âœ… å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
    else
      echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"
      exit 0
    fi
    ;;

  --help|"")
    show_usage
    ;;

  *)
    echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ '$1'" >&2
    echo "" >&2
    show_usage
    exit 1
    ;;
esac
